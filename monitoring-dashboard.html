<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitner Bot Monitoring Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .status-healthy { color: #10b981; }
        .status-degraded { color: #f59e0b; }
        .status-unhealthy { color: #ef4444; }
        .log-debug { color: #6b7280; }
        .log-info { color: #374151; }
        .log-warn { color: #f59e0b; }
        .log-error { color: #ef4444; }
        .log-critical { color: #dc2626; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-100">
    <div x-data="monitoringApp()" x-init="init()">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <i class="fas fa-chart-line text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-xl font-semibold text-gray-900">Leitner Bot Monitoring</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500" x-text="lastUpdate"></span>
                        <button @click="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Health Status Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-heartbeat text-2xl" 
                               :class="healthStatus?.status === 'healthy' ? 'text-green-500' : 
                                      healthStatus?.status === 'degraded' ? 'text-yellow-500' : 'text-red-500'"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Overall Health</dt>
                                <dd class="text-lg font-medium" 
                                    :class="healthStatus?.status === 'healthy' ? 'text-green-600' : 
                                           healthStatus?.status === 'degraded' ? 'text-yellow-600' : 'text-red-600'"
                                    x-text="healthStatus?.status || 'Unknown'"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock text-2xl text-blue-500"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Avg Response Time</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="(healthStatus?.metrics?.avgResponseTime || 0) + 'ms'"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exchange-alt text-2xl text-purple-500"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Requests/min</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="(healthStatus?.metrics?.requestsPerMinute || 0).toFixed(1)"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-2xl text-orange-500"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Error Rate</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="(healthStatus?.metrics?.errorRate || 0) + '%'"></dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i class="fas fa-users text-2xl text-green-500"></i>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">Active Users</dt>
                                <dd class="text-lg font-medium text-gray-900" x-text="healthStatus?.metrics?.activeUsers || 0"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Component Health -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Component Health</h3>
                    </div>
                    <div class="p-6">
                        <template x-for="(check, name) in healthStatus?.checks || {}" :key="name">
                            <div class="flex items-center justify-between py-2">
                                <div class="flex items-center">
                                    <i class="fas fa-circle text-sm mr-2"
                                       :class="check.status === 'up' ? 'text-green-500' : 
                                              check.status === 'degraded' ? 'text-yellow-500' : 'text-red-500'"></i>
                                    <span class="text-sm font-medium text-gray-900 capitalize" x-text="name"></span>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-900 capitalize" x-text="check.status"></div>
                                    <div class="text-xs text-gray-500" x-show="check.responseTime" x-text="check.responseTime + 'ms'"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Recent Metrics -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">System Metrics</h3>
                    </div>
                    <div class="p-6">
                        <template x-if="metrics?.today">
                            <div class="space-y-4">
                                <div>
                                    <div class="text-sm text-gray-500">Total Requests Today</div>
                                    <div class="text-2xl font-bold text-gray-900" x-text="metrics.today.requests.total"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Webhook</div>
                                        <div class="text-lg font-semibold text-gray-900" x-text="metrics.today.requests.webhook"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Admin</div>
                                        <div class="text-lg font-semibold text-gray-900" x-text="metrics.today.requests.admin"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Total Errors</div>
                                    <div class="text-lg font-semibold" 
                                         :class="metrics.today.errors.total > 0 ? 'text-red-600' : 'text-green-600'"
                                         x-text="metrics.today.errors.total"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Logs and Bulk Jobs -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Recent Logs -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">Recent Logs</h3>
                        <div class="flex items-center space-x-2">
                            <select x-model="logLevel" @change="loadLogs()" class="text-sm border-gray-300 rounded-md">
                                <option value="">All Levels</option>
                                <option value="DEBUG">Debug</option>
                                <option value="INFO">Info</option>
                                <option value="WARN">Warning</option>
                                <option value="ERROR">Error</option>
                                <option value="CRITICAL">Critical</option>
                            </select>
                            <select x-model="logComponent" @change="loadLogs()" class="text-sm border-gray-300 rounded-md">
                                <option value="">All Components</option>
                                <option value="MAIN_HANDLER">Main Handler</option>
                                <option value="ADMIN_API">Admin API</option>
                                <option value="ADMIN_SERVICE">Admin Service</option>
                                <option value="HEALTH_CHECK">Health Check</option>
                            </select>
                        </div>
                    </div>
                    <div class="p-6">
                        <div class="max-h-96 overflow-y-auto">
                            <template x-for="log in logs" :key="log.id">
                                <div class="mb-2 p-2 rounded text-xs font-mono"
                                     :class="'log-' + log.level.toLowerCase()">
                                    <div class="flex justify-between items-start">
                                        <span class="font-semibold">[<span x-text="formatTime(log.timestamp)"></span>] [<span x-text="log.level"></span>]</span>
                                        <span x-text="log.duration ? log.duration + 'ms' : ''" class="text-gray-500"></span>
                                    </div>
                                    <div>[<span x-text="log.component"></span>:<span x-text="log.action"></span>] <span x-text="log.message"></span></div>
                                    <div x-show="log.data && log.data !== '{}'" class="text-gray-600 ml-4" x-text="log.data"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Bulk Job Monitoring -->
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900">Bulk Job Monitor</h3>
                        <button @click="testBulkWords()" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                            <i class="fas fa-play mr-1"></i> Test Bulk Words
                        </button>
                    </div>
                    <div class="p-6">
                        <template x-if="currentJob">
                            <div class="space-y-4">
                                <div>
                                    <div class="text-sm text-gray-500">Job ID</div>
                                    <div class="text-sm font-mono" x-text="currentJob.jobId"></div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Status</div>
                                    <div class="text-sm font-semibold"
                                         :class="currentJob.status === 'completed' ? 'text-green-600' : 
                                                currentJob.status === 'failed' ? 'text-red-600' : 'text-yellow-600'"
                                         x-text="currentJob.status"></div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-500">Progress</div>
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                             :style="`width: ${(currentJob.processedWords / currentJob.totalWords * 100)}%`"></div>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-1" x-text="`${currentJob.processedWords}/${currentJob.totalWords} words`"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-sm text-gray-500">Success</div>
                                        <div class="text-lg font-semibold text-green-600" x-text="currentJob.successCount"></div>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-500">Errors</div>
                                        <div class="text-lg font-semibold text-red-600" x-text="currentJob.errorCount"></div>
                                    </div>
                                </div>
                                <div x-show="currentJob.logs && currentJob.logs.length > 0">
                                    <div class="text-sm text-gray-500 mb-2">Recent Activity</div>
                                    <div class="max-h-32 overflow-y-auto text-xs bg-gray-50 p-2 rounded">
                                        <template x-for="logEntry in currentJob.logs.slice(-5)" :key="logEntry">
                                            <div x-text="logEntry" class="mb-1"></div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template x-if="!currentJob">
                            <div class="text-center text-gray-500 py-8">
                                <i class="fas fa-tasks text-4xl mb-4"></i>
                                <p>No active bulk jobs</p>
                                <p class="text-sm">Click "Test Bulk Words" to start a test job</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function monitoringApp() {
            return {
                healthStatus: null,
                metrics: null,
                logs: [],
                currentJob: null,
                lastUpdate: '',
                logLevel: '',
                logComponent: '',
                autoRefresh: null,

                async init() {
                    await this.refreshData();
                    this.startAutoRefresh();
                },

                async refreshData() {
                    try {
                        await Promise.all([
                            this.loadHealth(),
                            this.loadMetrics(),
                            this.loadLogs()
                        ]);
                        this.lastUpdate = new Date().toLocaleTimeString();
                    } catch (error) {
                        console.error('Failed to refresh data:', error);
                    }
                },

                async loadHealth() {
                    try {
                        const response = await fetch('/admin/health');
                        this.healthStatus = await response.json();
                    } catch (error) {
                        console.error('Failed to load health status:', error);
                    }
                },

                async loadMetrics() {
                    try {
                        const response = await fetch('/admin/metrics');
                        this.metrics = await response.json();
                    } catch (error) {
                        console.error('Failed to load metrics:', error);
                    }
                },

                async loadLogs() {
                    try {
                        const params = new URLSearchParams({
                            limit: '50'
                        });
                        if (this.logLevel) params.append('level', this.logLevel);
                        if (this.logComponent) params.append('component', this.logComponent);

                        const response = await fetch(`/admin/logs?${params}`);
                        const data = await response.json();
                        this.logs = data.logs || [];
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                    }
                },

                async testBulkWords() {
                    try {
                        const testWords = ['investigation', 'technology', 'education', 'communication'];
                        const response = await fetch('/admin/bulk-words-ai', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                words: testWords,
                                meaningLanguage: 'fa',
                                definitionLanguage: 'en',
                                assignUsers: []
                            })
                        });

                        const result = await response.json();
                        if (result.jobId) {
                            this.currentJob = {
                                jobId: result.jobId,
                                status: 'processing',
                                totalWords: result.totalWords,
                                processedWords: 0,
                                successCount: 0,
                                errorCount: 0,
                                logs: []
                            };
                            this.monitorJob(result.jobId);
                        }
                    } catch (error) {
                        console.error('Failed to start bulk words test:', error);
                    }
                },

                async monitorJob(jobId) {
                    const checkInterval = setInterval(async () => {
                        try {
                            const response = await fetch(`/admin/bulk-words-progress/${jobId}`);
                            const progress = await response.json();
                            
                            this.currentJob = progress;
                            
                            if (progress.status === 'completed' || progress.status === 'failed') {
                                clearInterval(checkInterval);
                            }
                        } catch (error) {
                            console.error('Failed to check job progress:', error);
                            clearInterval(checkInterval);
                        }
                    }, 2000);
                },

                formatTime(timestamp) {
                    return new Date(timestamp).toLocaleTimeString();
                },

                startAutoRefresh() {
                    this.autoRefresh = setInterval(() => {
                        this.refreshData();
                    }, 30000); // Refresh every 30 seconds
                },

                stopAutoRefresh() {
                    if (this.autoRefresh) {
                        clearInterval(this.autoRefresh);
                        this.autoRefresh = null;
                    }
                }
            }
        }
    </script>
</body>
</html>
