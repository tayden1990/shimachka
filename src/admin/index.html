<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitner Bot Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div x-data="adminApp()" x-init="init()">
        <!-- Login Screen -->
        <div x-show="!isAuthenticated" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-md w-full space-y-8">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                        ðŸŽ¯ Leitner Bot Admin Panel
                    </h2>
                    <p class="mt-2 text-center text-sm text-gray-600">
                        Sign in to access the admin dashboard
                    </p>
                </div>
                <form @submit.prevent="login()" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <div>
                            <input x-model="loginForm.username" type="text" required
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Username">
                        </div>
                        <div>
                            <input x-model="loginForm.password" type="password" required
                                   class="relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Password">
                        </div>
                    </div>
                    <div>
                        <button type="submit" :disabled="loading"
                                class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50">
                            <span x-show="!loading">Sign in</span>
                            <span x-show="loading">Signing in...</span>
                        </button>
                    </div>
                    <div x-show="error" class="text-red-600 text-sm text-center" x-text="error"></div>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div x-show="isAuthenticated" class="min-h-screen bg-gray-100">
            <!-- Navigation -->
            <nav class="bg-white shadow-lg">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                            <h1 class="text-xl font-bold text-gray-900">ðŸŽ¯ Leitner Bot Admin</h1>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span class="text-gray-700" x-text="'Welcome, ' + admin.fullName"></span>
                            <button @click="logout()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Tab Navigation -->
            <div class="bg-white border-b">
                <div class="max-w-7xl mx-auto px-4">
                    <nav class="flex space-x-8">
                        <button @click="activeTab = 'dashboard'" 
                                :class="activeTab === 'dashboard' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-chart-dashboard mr-2"></i>Dashboard
                        </button>
                        <button @click="activeTab = 'users'" 
                                :class="activeTab === 'users' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-users mr-2"></i>Users
                        </button>
                        <button @click="activeTab = 'bulk-words'" 
                                :class="activeTab === 'bulk-words' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="py-4 px-1 border-b-2 font-medium text-sm relative">
                            <i class="fas fa-magic mr-2"></i>Bulk Words AI
                            <span class="absolute -top-1 -right-1 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded-full">NEW</span>
                        </button>
                        <button @click="activeTab = 'messages'" 
                                :class="activeTab === 'messages' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-envelope mr-2"></i>Messages
                        </button>
                        <button @click="activeTab = 'tickets'" 
                                :class="activeTab === 'tickets' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="py-4 px-1 border-b-2 font-medium text-sm">
                            <i class="fas fa-ticket-alt mr-2"></i>Support
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Content -->
            <div class="max-w-7xl mx-auto py-6 px-4">
                <!-- Dashboard Tab -->
                <div x-show="activeTab === 'dashboard'">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-users text-gray-400 text-2xl"></i>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Users</dt>
                                            <dd class="text-lg font-medium text-gray-900" x-text="stats.totalUsers"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-user-check text-green-400 text-2xl"></i>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Active Users</dt>
                                            <dd class="text-lg font-medium text-gray-900" x-text="stats.activeUsers"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-book text-blue-400 text-2xl"></i>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Total Cards</dt>
                                            <dd class="text-lg font-medium text-gray-900" x-text="stats.totalCards"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow rounded-lg">
                            <div class="p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-ticket-alt text-red-400 text-2xl"></i>
                                    </div>
                                    <div class="ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-sm font-medium text-gray-500 truncate">Open Tickets</dt>
                                            <dd class="text-lg font-medium text-gray-900" x-text="stats.openTickets"></dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Feature Highlights -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Bulk Words AI Feature -->
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-magic text-3xl mr-4"></i>
                                <div>
                                    <h3 class="text-xl font-bold">AI-Powered Bulk Words</h3>
                                    <p class="text-indigo-100">Add multiple words instantly with AI</p>
                                </div>
                            </div>
                            <p class="text-indigo-100 mb-4">
                                ðŸš€ Add hundreds of words at once! Just paste your word list and let AI generate meanings and definitions automatically.
                            </p>
                            <button @click="activeTab = 'bulk-words'" 
                                    class="bg-white text-indigo-600 px-6 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition">
                                Try Bulk Words AI â†’
                            </button>
                        </div>
                        
                        <!-- User Management -->
                        <div class="bg-white rounded-lg shadow-lg p-6 border border-gray-200">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-users text-3xl mr-4 text-gray-600"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900">User Management</h3>
                                    <p class="text-gray-600">Monitor learning progress</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-4">
                                ðŸ“Š View detailed user statistics, learning progress, and assign words to specific users.
                            </p>
                            <button @click="activeTab = 'users'" 
                                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                Manage Users â†’
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div x-show="activeTab === 'users'">
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">User Management</h3>
                            <button @click="refreshUsers()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                        <ul class="divide-y divide-gray-200">
                            <template x-for="user in users" :key="user.id">
                                <li class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center flex-1">
                                            <div class="flex-shrink-0 h-12 w-12">
                                                <div class="h-12 w-12 rounded-full bg-gradient-to-r from-purple-400 to-pink-400 flex items-center justify-center">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            </div>
                                            <div class="ml-4 flex-1">
                                                <div class="flex items-center justify-between">
                                                    <div>
                                                        <div class="text-sm font-medium text-gray-900" x-text="user.fullName || user.firstName || 'No name'"></div>
                                                        <div class="text-sm text-gray-500" x-text="user.email || 'No email'"></div>
                                                        <div class="text-xs text-gray-400" x-text="'ID: ' + user.id + ' | Language: ' + user.interfaceLanguage"></div>
                                                    </div>
                                                    <div class="text-right">
                                                        <div class="text-sm font-medium text-gray-900" x-text="(user.stats?.totalCards || 0) + ' cards'"></div>
                                                        <div class="text-sm text-green-600" x-text="(user.stats?.masteredCards || 0) + ' mastered'"></div>
                                                        <div class="text-xs text-gray-500" x-text="(user.stats?.accuracy || 0) + '% accuracy'"></div>
                                                    </div>
                                                </div>
                                                <!-- Progress bars for Leitner boxes -->
                                                <div class="mt-2">
                                                    <div class="text-xs text-gray-500 mb-1">Learning Progress</div>
                                                    <div class="flex space-x-1">
                                                        <template x-for="(count, index) in (user.stats?.boxDistribution || [0,0,0,0,0])" :key="index">
                                                            <div class="flex-1">
                                                                <div class="text-xs text-center mb-1" x-text="'Box ' + (index + 1)"></div>
                                                                <div class="bg-gray-200 rounded-full h-2">
                                                                    <div :class="getBoxColor(index)" 
                                                                         :style="'width: ' + Math.min(100, (count / Math.max(1, user.stats?.totalCards || 1)) * 100) + '%'"
                                                                         class="h-2 rounded-full"></div>
                                                                </div>
                                                                <div class="text-xs text-center mt-1" x-text="count"></div>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex space-x-2 ml-4">
                                            <button @click="viewUserDetails(user)" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-xs">
                                                <i class="fas fa-eye mr-1"></i>Details
                                            </button>
                                            <button @click="sendMessageToUser(user)" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-xs">
                                                <i class="fas fa-envelope mr-1"></i>Message
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>

                <!-- Bulk Words Tab -->
                <div x-show="activeTab === 'bulk-words'">
                    <div class="space-y-6">
                        <!-- Simple Bulk Word Addition -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                    <i class="fas fa-magic mr-2"></i>Add Bulk Words with AI
                                </h3>
                                <p class="text-sm text-gray-600 mb-4">Enter words (one per line) and let AI automatically generate meanings and definitions.</p>
                                
                                <form @submit.prevent="startBulkWordProcessing()">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assignment Title</label>
                                            <input x-model="bulkWordsForm.title" type="text" required
                                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Words (one per line)</label>
                                            <textarea x-model="bulkWordsForm.words" rows="8" required
                                                      placeholder="hello&#10;world&#10;language&#10;learning&#10;education"
                                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                            <p class="mt-1 text-sm text-gray-500">Enter one word per line. AI will generate meanings and definitions automatically.</p>
                                        </div>

                                        <div class="grid grid-cols-2 gap-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Source Language (Word Language)</label>
                                                <select x-model="bulkWordsForm.sourceLanguage" required
                                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="">Select language</option>
                                                    <option value="en">English</option>
                                                    <option value="fa">Persian/Farsi</option>
                                                    <option value="ar">Arabic</option>
                                                    <option value="es">Spanish</option>
                                                    <option value="ru">Russian</option>
                                                    <option value="fr">French</option>
                                                    <option value="de">German</option>
                                                    <option value="it">Italian</option>
                                                    <option value="pt">Portuguese</option>
                                                    <option value="ja">Japanese</option>
                                                    <option value="ko">Korean</option>
                                                    <option value="zh">Chinese</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700">Target Language (Meaning Language)</label>
                                                <select x-model="bulkWordsForm.targetLanguage" required
                                                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                    <option value="">Select language</option>
                                                    <option value="en">English</option>
                                                    <option value="fa">Persian/Farsi</option>
                                                    <option value="ar">Arabic</option>
                                                    <option value="es">Spanish</option>
                                                    <option value="ru">Russian</option>
                                                    <option value="fr">French</option>
                                                    <option value="de">German</option>
                                                    <option value="it">Italian</option>
                                                    <option value="pt">Portuguese</option>
                                                    <option value="ja">Japanese</option>
                                                    <option value="ko">Korean</option>
                                                    <option value="zh">Chinese</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assign to Users</label>
                                            <div class="mt-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-3">
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="checkbox" @change="toggleAllUsers($event.target.checked)" 
                                                               class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                                        <span class="ml-2 text-sm font-medium text-gray-700">Select All Users</span>
                                                    </label>
                                                    <template x-for="user in users" :key="user.id">
                                                        <label class="flex items-center">
                                                            <input type="checkbox" :value="user.id" x-model="bulkWordsForm.selectedUsers"
                                                                   class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                                            <span class="ml-2 text-sm text-gray-700" x-text="user.fullName || user.firstName || 'User ' + user.id"></span>
                                                            <span class="ml-2 text-xs text-gray-500" x-text="'(' + user.id + ')'"></span>
                                                        </label>
                                                    </template>
                                                </div>
                                            </div>
                                            <p class="mt-1 text-sm text-gray-500">Select users who will receive these words in their learning decks.</p>
                                        </div>

                                        <div>
                                            <button type="submit" :disabled="bulkProcessing"
                                                    class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-bold py-3 px-4 rounded">
                                                <span x-show="!bulkProcessing">
                                                    <i class="fas fa-rocket mr-2"></i>Start AI Processing
                                                </span>
                                                <span x-show="bulkProcessing">
                                                    <i class="fas fa-spinner fa-spin mr-2"></i>Processing...
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Progress Section -->
                        <div x-show="bulkProcessing || bulkProcessLog.length > 0" class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                    <i class="fas fa-tasks mr-2"></i>Processing Progress
                                </h3>
                                
                                <!-- Progress Bar -->
                                <div class="mb-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700">Overall Progress</span>
                                        <span class="text-sm text-gray-500" x-text="bulkProgress.processed + ' / ' + bulkProgress.total + ' words'"></span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-300" 
                                             :style="'width: ' + (bulkProgress.total > 0 ? (bulkProgress.processed / bulkProgress.total) * 100 : 0) + '%'"></div>
                                    </div>
                                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                                        <span x-text="'Success: ' + bulkProgress.success"></span>
                                        <span x-text="'Errors: ' + bulkProgress.errors"></span>
                                    </div>
                                </div>

                                <!-- Live Log -->
                                <div class="bg-gray-50 rounded-lg p-4 max-h-60 overflow-y-auto">
                                    <h4 class="text-sm font-medium text-gray-700 mb-2">Processing Log</h4>
                                    <div class="space-y-1">
                                        <template x-for="(log, index) in bulkProcessLog" :key="index">
                                            <div class="flex items-center text-sm">
                                                <div :class="getLogIcon(log.type)" class="w-4 h-4 mr-2"></div>
                                                <span class="text-gray-600" x-text="log.timestamp"></span>
                                                <span class="ml-2" :class="getLogColor(log.type)" x-text="log.message"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Manual Assignment (Existing) -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Manual Word Assignment (Advanced)</h3>
                                
                                <form @submit.prevent="createBulkAssignment()">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Assignment Title</label>
                                            <input x-model="bulkForm.title" type="text" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Description</label>
                                            <textarea x-model="bulkForm.description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Target User IDs (comma-separated)</label>
                                            <input x-model="bulkForm.userIds" type="text" placeholder="123,456,789" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Words (JSON format)</label>
                                            <textarea x-model="bulkForm.words" rows="10" 
                                                      placeholder='[{"word":"hello","translation":"Ø³Ù„Ø§Ù…","definition":"A greeting","sourceLanguage":"en","targetLanguage":"fa"}]'
                                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>

                                        <div>
                                            <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                                                Create Assignment
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Messages Tab -->
                <div x-show="activeTab === 'messages'">
                    <div class="space-y-6">
                        <!-- Direct Message -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                    <i class="fas fa-envelope mr-2 text-blue-500"></i>Send Direct Message
                                </h3>
                                
                                <form @submit.prevent="sendDirectMessage()">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">User ID</label>
                                            <input x-model="messageForm.userId" type="number" placeholder="Enter user ID" 
                                                   class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Message</label>
                                            <textarea x-model="messageForm.message" rows="4" placeholder="Enter your message..." 
                                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>

                                        <div>
                                            <button type="submit" :disabled="!messageForm.userId || !messageForm.message" 
                                                    class="bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded">
                                                <i class="fas fa-paper-plane mr-2"></i>Send Message
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Bulk Message -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                    <i class="fas fa-users mr-2 text-green-500"></i>Send Bulk Message
                                </h3>
                                
                                <form @submit.prevent="sendBulkMessage()">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Select Recipients</label>
                                            <div class="mt-2 space-y-2">
                                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                                    <label class="flex items-center">
                                                        <input type="checkbox" x-model="bulkMessageForm.selectAll" @change="toggleSelectAllUsers()" 
                                                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                        <span class="ml-2 text-sm font-medium text-gray-700">Select All Users</span>
                                                    </label>
                                                    <span class="text-sm text-gray-500" x-text="`${bulkMessageForm.selectedUsers.length} selected`"></span>
                                                </div>
                                                
                                                <div class="max-h-40 overflow-y-auto border border-gray-200 rounded-md">
                                                    <template x-for="user in users" :key="user.id">
                                                        <label class="flex items-center p-2 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
                                                            <input type="checkbox" :value="user.id" x-model="bulkMessageForm.selectedUsers" 
                                                                   class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                                            <span class="ml-2 text-sm text-gray-700" x-text="`${user.firstName} ${user.lastName} (ID: ${user.id})`"></span>
                                                        </label>
                                                    </template>
                                                </div>
                                                
                                                <div class="text-xs text-gray-500 mt-1">
                                                    Or enter User IDs manually (comma-separated):
                                                </div>
                                                <input x-model="bulkMessageForm.manualUserIds" type="text" placeholder="123, 456, 789" 
                                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Message</label>
                                            <textarea x-model="bulkMessageForm.message" rows="4" placeholder="Enter message to send to selected users..." 
                                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                                        </div>

                                        <div>
                                            <button type="submit" :disabled="(bulkMessageForm.selectedUsers.length === 0 && !bulkMessageForm.manualUserIds) || !bulkMessageForm.message" 
                                                    class="bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded">
                                                <i class="fas fa-paper-plane mr-2"></i>Send to Selected Users
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Broadcast Message -->
                        <div class="bg-white shadow sm:rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
                                    <i class="fas fa-bullhorn mr-2 text-red-500"></i>Send Broadcast Message
                                </h3>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-4">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-yellow-700">
                                                This will send the message to <strong>all registered users</strong>. Use with caution.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <form @submit.prevent="sendBroadcastMessage()">
                                    <div class="grid grid-cols-1 gap-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700">Broadcast Message</label>
                                            <textarea x-model="broadcastForm.message" rows="4" placeholder="Enter message to broadcast to all users..." 
                                                      class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></textarea>
                                        </div>

                                        <div>
                                            <button type="submit" :disabled="!broadcastForm.message" 
                                                    class="bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-bold py-2 px-4 rounded">
                                                <i class="fas fa-bullhorn mr-2"></i>Send to All Users
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Support Tickets Tab -->
                <div x-show="activeTab === 'tickets'">
                    <div class="bg-white shadow overflow-hidden sm:rounded-md">
                        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Support Tickets</h3>
                            <button @click="refreshTickets()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                        </div>
                        <ul class="divide-y divide-gray-200">
                            <template x-for="ticket in tickets" :key="ticket.id">
                                <li class="px-4 py-4 sm:px-6">
                                    <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center justify-between">
                                                <div class="text-sm font-medium text-gray-900" x-text="ticket.subject"></div>
                                                <div class="flex items-center space-x-2">
                                                    <span :class="getTicketStatusColor(ticket.status)" class="px-2 py-1 text-xs font-semibold rounded-full" x-text="ticket.status.toUpperCase()"></span>
                                                    <span :class="getTicketPriorityColor(ticket.priority)" class="px-2 py-1 text-xs font-semibold rounded-full" x-text="ticket.priority.toUpperCase()"></span>
                                                </div>
                                            </div>
                                            <div class="mt-1 text-sm text-gray-500" x-text="ticket.message"></div>
                                            <div class="mt-1 text-xs text-gray-400" x-text="'From: ' + (ticket.userName || 'User ID: ' + ticket.userId) + ' | ' + new Date(ticket.createdAt).toLocaleDateString()"></div>
                                        </div>
                                        <div class="ml-4 flex space-x-2">
                                            <button @click="respondToTicket(ticket)" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-xs">
                                                Respond
                                            </button>
                                        </div>
                                    </div>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals and alerts would go here -->
        
        <!-- User Details Modal -->
        <div x-show="showUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" @click="showUserModal = false">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white" @click.stop>
                <div class="mt-3">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">User Details</h3>
                        <button @click="showUserModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div x-show="selectedUser" class="space-y-6">
                        <!-- Basic Info -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Basic Information</h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Name:</span>
                                    <p class="text-sm text-gray-900" x-text="selectedUser?.fullName || selectedUser?.firstName || 'N/A'"></p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Email:</span>
                                    <p class="text-sm text-gray-900" x-text="selectedUser?.email || 'N/A'"></p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">User ID:</span>
                                    <p class="text-sm text-gray-900" x-text="selectedUser?.id"></p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Interface Language:</span>
                                    <p class="text-sm text-gray-900" x-text="selectedUser?.interfaceLanguage || 'N/A'"></p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Registration Status:</span>
                                    <p class="text-sm" :class="selectedUser?.isRegistrationComplete ? 'text-green-600' : 'text-red-600'" 
                                       x-text="selectedUser?.isRegistrationComplete ? 'Complete' : 'Incomplete'"></p>
                                </div>
                                <div>
                                    <span class="text-sm font-medium text-gray-500">Last Active:</span>
                                    <p class="text-sm text-gray-900" x-text="selectedUser?.lastActiveAt ? new Date(selectedUser.lastActiveAt).toLocaleString() : 'N/A'"></p>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Stats -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Learning Statistics</h4>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-blue-600" x-text="selectedUser?.stats?.totalCards || 0"></p>
                                    <p class="text-sm text-gray-600">Total Cards</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-green-600" x-text="selectedUser?.stats?.masteredCards || 0"></p>
                                    <p class="text-sm text-gray-600">Mastered</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-2xl font-bold text-purple-600" x-text="(selectedUser?.stats?.accuracy || 0) + '%'"></p>
                                    <p class="text-sm text-gray-600">Accuracy</p>
                                </div>
                            </div>
                        </div>

                        <!-- Leitner Box Distribution -->
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Leitner Box Distribution</h4>
                            <div class="space-y-3">
                                <template x-for="(count, index) in (selectedUser?.stats?.boxDistribution || [0,0,0,0,0])" :key="index">
                                    <div class="flex items-center">
                                        <div class="w-16 text-sm font-medium" x-text="'Box ' + (index + 1)"></div>
                                        <div class="flex-1 mx-3">
                                            <div class="bg-gray-200 rounded-full h-4">
                                                <div :class="getBoxColor(index)" 
                                                     :style="'width: ' + Math.min(100, (count / Math.max(1, selectedUser?.stats?.totalCards || 1)) * 100) + '%'"
                                                     class="h-4 rounded-full"></div>
                                            </div>
                                        </div>
                                        <div class="w-12 text-sm text-right" x-text="count + ' cards'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="text-md font-semibold text-gray-900 mb-3">Recent Activity</h4>
                            <div x-show="selectedUser?.recentActivity && selectedUser.recentActivity.length > 0">
                                <template x-for="activity in selectedUser.recentActivity" :key="activity.id">
                                    <div class="flex justify-between py-2 border-b border-green-200 last:border-b-0">
                                        <span class="text-sm text-gray-700" x-text="activity.action"></span>
                                        <span class="text-xs text-gray-500" x-text="new Date(activity.timestamp).toLocaleDateString()"></span>
                                    </div>
                                </template>
                            </div>
                            <div x-show="!selectedUser?.recentActivity || selectedUser.recentActivity.length === 0" class="text-sm text-gray-500">
                                No recent activity
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alert -->
        <div x-show="showAlert" class="fixed inset-0 flex items-end justify-center px-4 py-6 pointer-events-none sm:p-6 sm:items-start sm:justify-end">
            <div class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto">
                <div class="p-4">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <i :class="alertType === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-exclamation-circle text-red-400'"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900" x-text="alertMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminApp() {
            return {
                isAuthenticated: false,
                admin: null,
                token: null,
                activeTab: 'dashboard',
                loading: false,
                error: '',
                showAlert: false,
                alertMessage: '',
                alertType: 'success',
                
                // Login form
                loginForm: {
                    username: '',
                    password: ''
                },

                // Dashboard stats
                stats: {
                    totalUsers: 0,
                    activeUsers: 0,
                    totalCards: 0,
                    openTickets: 0
                },

                // Users
                users: [],
                selectedUser: null,
                showUserModal: false,

                // Bulk assignment form
                bulkForm: {
                    title: '',
                    description: '',
                    userIds: '',
                    words: ''
                },

                // Enhanced bulk words form
                bulkWordsForm: {
                    title: '',
                    words: '',
                    sourceLanguage: '',
                    targetLanguage: '',
                    selectedUsers: []
                },
                bulkProcessing: false,
                bulkProgress: {
                    total: 0,
                    processed: 0,
                    success: 0,
                    errors: 0
                },
                bulkProcessLog: [],

                // Message form
                messageForm: {
                    userId: '',
                    message: ''
                },

                // Bulk message form
                bulkMessageForm: {
                    selectedUsers: [],
                    manualUserIds: '',
                    message: '',
                    selectAll: false
                },

                // Broadcast form
                broadcastForm: {
                    message: ''
                },

                // Support tickets
                tickets: [],

                init() {
                    // Check for stored auth
                    const storedToken = localStorage.getItem('adminToken');
                    if (storedToken) {
                        this.token = storedToken;
                        this.isAuthenticated = true;
                        this.loadAdminInfo();
                        this.loadDashboard();
                        this.refreshUsers(); // Load users on init
                    }
                },

                async login() {
                    this.loading = true;
                    this.error = '';
                    
                    try {
                        const response = await fetch('/admin/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(this.loginForm)
                        });

                        const data = await response.json();
                        
                        if (response.ok) {
                            this.admin = data.admin;
                            this.token = data.token;
                            this.isAuthenticated = true;
                            localStorage.setItem('adminToken', this.token);
                            await this.loadDashboard();
                        } else {
                            this.error = data.error || 'Login failed';
                        }
                    } catch (err) {
                        this.error = 'Network error. Please try again.';
                    }
                    
                    this.loading = false;
                },

                logout() {
                    this.isAuthenticated = false;
                    this.admin = null;
                    this.token = null;
                    localStorage.removeItem('adminToken');
                },

                async loadAdminInfo() {
                    try {
                        const response = await fetch('/admin/profile', {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        if (response.ok) {
                            this.admin = await response.json();
                        } else if (response.status === 401) {
                            // Token expired or invalid
                            this.logout();
                        }
                    } catch (err) {
                        console.error('Failed to load admin info:', err);
                    }
                },

                async loadDashboard() {
                    try {
                        const response = await fetch('/admin/dashboard', {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        if (response.ok) {
                            this.stats = await response.json();
                        }
                    } catch (err) {
                        console.error('Failed to load dashboard:', err);
                    }
                },

                async refreshUsers() {
                    try {
                        const response = await fetch('/admin/users', {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.users = data.users;
                            // Load stats for each user
                            await this.loadUsersStats();
                        }
                    } catch (err) {
                        console.error('Failed to load users:', err);
                    }
                },

                async loadUsersStats() {
                    for (let user of this.users) {
                        try {
                            const response = await fetch(`/admin/users/${user.id}/stats`, {
                                headers: {
                                    'Authorization': `Bearer ${this.token}`
                                }
                            });
                            
                            if (response.ok) {
                                const stats = await response.json();
                                user.stats = stats;
                            }
                        } catch (err) {
                            console.error(`Failed to load stats for user ${user.id}:`, err);
                        }
                    }
                },

                async viewUserDetails(user) {
                    try {
                        // Load detailed user information
                        const response = await fetch(`/admin/users/${user.id}/details`, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        
                        if (response.ok) {
                            this.selectedUser = await response.json();
                            this.showUserModal = true;
                        }
                    } catch (err) {
                        console.error('Failed to load user details:', err);
                    }
                },

                getBoxColor(index) {
                    const colors = [
                        'bg-red-500',    // Box 1 - Daily review
                        'bg-orange-500', // Box 2 - Every 2 days
                        'bg-yellow-500', // Box 3 - Every 4 days
                        'bg-green-500',  // Box 4 - Every 8 days
                        'bg-blue-500'    // Box 5 - Every 16 days
                    ];
                    return colors[index] || 'bg-gray-500';
                },

                toggleAllUsers(selectAll) {
                    if (selectAll) {
                        this.bulkWordsForm.selectedUsers = this.users.map(user => user.id);
                    } else {
                        this.bulkWordsForm.selectedUsers = [];
                    }
                },

                async startBulkWordProcessing() {
                    if (!this.bulkWordsForm.title || !this.bulkWordsForm.words || 
                        !this.bulkWordsForm.sourceLanguage || !this.bulkWordsForm.targetLanguage ||
                        this.bulkWordsForm.selectedUsers.length === 0) {
                        this.showAlertMessage('Please fill in all required fields and select at least one user.', 'error');
                        return;
                    }

                    this.bulkProcessing = true;
                    this.bulkProcessLog = [];
                    
                    const words = this.bulkWordsForm.words.split('\n')
                        .map(w => w.trim())
                        .filter(w => w.length > 0);
                    
                    this.bulkProgress = {
                        total: words.length,
                        processed: 0,
                        success: 0,
                        errors: 0
                    };

                    this.addLog('info', `Starting bulk processing of ${words.length} words for ${this.bulkWordsForm.selectedUsers.length} users`);

                    try {
                        const response = await fetch('/admin/bulk-words-ai', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                title: this.bulkWordsForm.title,
                                words: words,
                                sourceLanguage: this.bulkWordsForm.sourceLanguage,
                                targetLanguage: this.bulkWordsForm.targetLanguage,
                                targetUserIds: this.bulkWordsForm.selectedUsers,
                                adminId: this.admin.id
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.processWordsWithProgress(result.jobId);
                        } else {
                            const error = await response.json();
                            this.addLog('error', `Failed to start processing: ${error.error}`);
                            this.bulkProcessing = false;
                        }
                    } catch (err) {
                        this.addLog('error', `Network error: ${err.message}`);
                        this.bulkProcessing = false;
                    }
                },

                async processWordsWithProgress(jobId) {
                    const checkProgress = async () => {
                        try {
                            const response = await fetch(`/admin/bulk-words-progress/${jobId}`, {
                                headers: {
                                    'Authorization': `Bearer ${this.token}`
                                }
                            });

                            if (response.ok) {
                                const progress = await response.json();
                                
                                this.bulkProgress = {
                                    total: progress.total,
                                    processed: progress.processed,
                                    success: progress.success,
                                    errors: progress.errors
                                };

                                // Add new logs
                                if (progress.logs) {
                                    progress.logs.forEach(log => {
                                        if (!this.bulkProcessLog.some(existing => existing.id === log.id)) {
                                            this.bulkProcessLog.push(log);
                                        }
                                    });
                                }

                                if (progress.completed) {
                                    this.bulkProcessing = false;
                                    this.addLog('success', `Processing completed! ${progress.success} words processed successfully, ${progress.errors} errors.`);
                                    this.bulkWordsForm = {
                                        title: '',
                                        words: '',
                                        sourceLanguage: '',
                                        targetLanguage: '',
                                        selectedUsers: []
                                    };
                                } else {
                                    // Continue checking
                                    setTimeout(checkProgress, 2000);
                                }
                            }
                        } catch (err) {
                            this.addLog('error', `Progress check failed: ${err.message}`);
                            this.bulkProcessing = false;
                        }
                    };

                    checkProgress();
                },

                addLog(type, message) {
                    this.bulkProcessLog.push({
                        id: Date.now() + Math.random(),
                        type: type,
                        message: message,
                        timestamp: new Date().toLocaleTimeString()
                    });
                },

                getLogIcon(type) {
                    const icons = {
                        'info': 'fas fa-info-circle text-blue-500',
                        'success': 'fas fa-check-circle text-green-500',
                        'error': 'fas fa-exclamation-circle text-red-500',
                        'warning': 'fas fa-exclamation-triangle text-yellow-500'
                    };
                    return icons[type] || 'fas fa-circle text-gray-500';
                },

                getLogColor(type) {
                    const colors = {
                        'info': 'text-blue-700',
                        'success': 'text-green-700',
                        'error': 'text-red-700',
                        'warning': 'text-yellow-700'
                    };
                    return colors[type] || 'text-gray-700';
                },

                async createBulkAssignment() {
                    try {
                        const userIds = this.bulkForm.userIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
                        const words = JSON.parse(this.bulkForm.words);

                        const response = await fetch('/admin/bulk-assignment', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                adminId: this.admin.id,
                                targetUserIds: userIds,
                                words: words,
                                title: this.bulkForm.title,
                                description: this.bulkForm.description
                            })
                        });

                        if (response.ok) {
                            this.showAlertMessage('Bulk assignment created successfully!', 'success');
                            this.bulkForm = { title: '', description: '', userIds: '', words: '' };
                        } else {
                            const error = await response.json();
                            this.showAlertMessage(error.error || 'Failed to create assignment', 'error');
                        }
                    } catch (err) {
                        this.showAlertMessage('Invalid JSON format or network error', 'error');
                    }
                },

                async sendDirectMessage() {
                    try {
                        const response = await fetch('/admin/send-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                userId: parseInt(this.messageForm.userId),
                                message: this.messageForm.message
                            })
                        });

                        if (response.ok) {
                            this.showAlertMessage('Message sent successfully!', 'success');
                            this.messageForm = { userId: '', message: '' };
                        } else {
                            const error = await response.json();
                            this.showAlertMessage(error.error || 'Failed to send message', 'error');
                        }
                    } catch (err) {
                        this.showAlertMessage('Network error', 'error');
                    }
                },

                toggleSelectAllUsers() {
                    if (this.bulkMessageForm.selectAll) {
                        this.bulkMessageForm.selectedUsers = this.users.map(user => user.id);
                    } else {
                        this.bulkMessageForm.selectedUsers = [];
                    }
                },

                async sendBulkMessage() {
                    try {
                        let userIds = [...this.bulkMessageForm.selectedUsers];
                        
                        // Add manual user IDs if provided
                        if (this.bulkMessageForm.manualUserIds) {
                            const manualIds = this.bulkMessageForm.manualUserIds
                                .split(',')
                                .map(id => parseInt(id.trim()))
                                .filter(id => !isNaN(id));
                            userIds = [...new Set([...userIds, ...manualIds])]; // Remove duplicates
                        }

                        if (userIds.length === 0) {
                            this.showAlertMessage('Please select at least one user', 'error');
                            return;
                        }

                        const response = await fetch('/admin/send-bulk-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                userIds: userIds,
                                message: this.bulkMessageForm.message
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showAlertMessage(`Bulk message sent! Success: ${result.success}, Failed: ${result.failed}`, 'success');
                            this.bulkMessageForm = { selectedUsers: [], manualUserIds: '', message: '', selectAll: false };
                        } else {
                            const error = await response.json();
                            this.showAlertMessage(error.error || 'Failed to send bulk message', 'error');
                        }
                    } catch (err) {
                        this.showAlertMessage('Network error', 'error');
                    }
                },

                async sendBroadcastMessage() {
                    if (!confirm('Are you sure you want to send this message to ALL users? This action cannot be undone.')) {
                        return;
                    }

                    try {
                        const response = await fetch('/admin/send-broadcast-message', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                message: this.broadcastForm.message
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showAlertMessage(`Broadcast message sent! Success: ${result.success}, Failed: ${result.failed}`, 'success');
                            this.broadcastForm = { message: '' };
                        } else {
                            const error = await response.json();
                            this.showAlertMessage(error.error || 'Failed to send broadcast message', 'error');
                        }
                    } catch (err) {
                        this.showAlertMessage('Network error', 'error');
                    }
                },

                sendMessageToUser(user) {
                    this.messageForm.userId = user.id;
                    this.activeTab = 'messages';
                    // Scroll to top to show the message form
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                async refreshTickets() {
                    try {
                        const response = await fetch('/admin/tickets', {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.tickets = data.tickets;
                        }
                    } catch (err) {
                        console.error('Failed to load tickets:', err);
                    }
                },

                getTicketStatusColor(status) {
                    const colors = {
                        'open': 'bg-red-100 text-red-800',
                        'in_progress': 'bg-yellow-100 text-yellow-800',
                        'resolved': 'bg-green-100 text-green-800',
                        'closed': 'bg-gray-100 text-gray-800'
                    };
                    return colors[status] || 'bg-gray-100 text-gray-800';
                },

                getTicketPriorityColor(priority) {
                    const colors = {
                        'low': 'bg-blue-100 text-blue-800',
                        'medium': 'bg-yellow-100 text-yellow-800',
                        'high': 'bg-orange-100 text-orange-800',
                        'urgent': 'bg-red-100 text-red-800'
                    };
                    return colors[priority] || 'bg-gray-100 text-gray-800';
                },

                showAlertMessage(message, type) {
                    this.alertMessage = message;
                    this.alertType = type;
                    this.showAlert = true;
                    setTimeout(() => {
                        this.showAlert = false;
                    }, 3000);
                },

                sendMessageToUser(user) {
                    this.messageForm.userId = user.id;
                    this.activeTab = 'messages';
                },

                async respondToTicket(ticket) {
                    const response = prompt('Enter your response to this ticket:');
                    if (response) {
                        try {
                            console.log('Responding to ticket:', ticket.id, 'with admin ID:', this.admin?.id);
                            console.log('Using token:', this.token ? 'Token available' : 'No token');
                            
                            // Update ticket with response
                            const apiResponse = await fetch(`/admin/tickets/${ticket.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${this.token}`
                                },
                                body: JSON.stringify({
                                    status: 'resolved',
                                    adminResponse: response,
                                    assignedToAdmin: this.admin?.id || 'admin'
                                })
                            });

                            console.log('API Response status:', apiResponse.status);
                            console.log('API Response ok:', apiResponse.ok);

                            if (apiResponse.ok) {
                                await this.refreshTickets();
                                this.showAlertMessage('Response sent successfully!', 'success');
                            } else {
                                const errorData = await apiResponse.json().catch(() => ({ error: 'Unknown error' }));
                                console.error('API Error:', errorData);
                                this.showAlertMessage(`Failed to send response: ${errorData.error || 'Network error'}`, 'error');
                            }
                        } catch (error) {
                            console.error('Error responding to ticket:', error);
                            this.showAlertMessage(`Network error: ${error.message || 'Unable to connect to server'}`, 'error');
                        }
                    }
                }
            }
        }
    </script>
</body>
</html>
